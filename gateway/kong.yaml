_format_version: "3.0"

upstreams:
  - name: auth_guarded_api
    targets:
      - target: oauth2-proxy:4180
        weight: 100

services:
  # Auth-guarded GraphQL via oauth2-proxy â†’ teaapi
  - name: teaapp-api
    host: auth_guarded_api
    protocol: http
    port: 4180
    routes:
      - name: teaapp-api-graphql
        paths: ["/graphql"]
        strip_path: false
        plugins:
          - name: rate-limiting
            config:
              second: 5
              policy: local
  # Direct health route straight to teaapi (so Kong can ping without a token)
  - name: teaapp-health
    url: http://teaapi:8080
    routes:
      - name: teaapp-api-health
        paths: ["/health"]
        strip_path: false